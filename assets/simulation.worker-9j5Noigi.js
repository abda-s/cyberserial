(function(){"use strict";const m=self;let p=!1,l=null,v=0,T=9600,x=9600,A=60,y=.001,u={dataBits:8,parity:"none",stopBits:1,idleBits:0},i={dataBits:8,parity:"none",stopBits:1};const S=[],B=[];let E=!1;class P{state="IDLE";bitIndex=0;currentByte=0;timeInState=0;bitDuration=0;txCompleteSent=!1;constructor(){this.updateConfig()}updateConfig(){this.bitDuration=1/T}tick(s){if(this.state==="IDLE"){this.timeInState+=s;const t=(u.idleBits||0)*this.bitDuration;if(this.timeInState<t)return 1;if(S.length>0){const e=S.shift();return e!==void 0&&this.startTransmission(e),1}if(E){const e=Math.floor(Math.random()*93+33);this.startTransmission(e)}return 1}if(this.timeInState+=s,this.timeInState>=this.bitDuration){const t=this.timeInState-this.bitDuration;this.timeInState=t,this.advanceState()}return this.getOutputLevel()}stopBitCounter=0;startTransmission(s){this.currentByte=s,this.state="START",this.timeInState=0,this.bitIndex=0,this.stopBitCounter=0,this.txCompleteSent=!1,B.push(s)}advanceState(){switch(this.state){case"START":this.state="DATA",this.bitIndex=0;break;case"DATA":this.bitIndex++,this.bitIndex>=u.dataBits&&(u.parity!=="none"?this.state="PARITY":(this.state="STOP",this.stopBitCounter=0));break;case"PARITY":this.state="STOP",this.stopBitCounter=0;break;case"STOP":this.stopBitCounter++,this.stopBitCounter>=u.stopBits?(this.state="IDLE",this.timeInState=0):this.timeInState=0;break}}getOutputLevel(){switch(this.state){case"IDLE":return 1;case"START":return 0;case"DATA":return this.currentByte>>this.bitIndex&1;case"PARITY":return this.calculateParity(this.currentByte);case"STOP":return 1;default:return 1}}calculateParity(s){let t=0;for(let e=0;e<u.dataBits;e++)s>>e&1&&t++;return u.parity==="even"?t%2===0?0:1:t%2!==0?0:1}shouldSignalComplete(){return!E&&this.state==="IDLE"&&S.length===0&&this.timeInState>this.bitDuration*3&&!this.txCompleteSent}}class M{state="HUNTING";timeSinceStart=0;lastRxLevel=1;bitDuration=1/x;rxEventQueue=[];rxBuffer=0;dataEmitted=!1;signalAccumulator=0;sampleCount=0;emitData(s,t){if(this.dataEmitted)return;let e=!1,a=!1;const n=Math.min(B.length,50);for(let r=0;r<n;r++)if(B[r]===s){B.splice(0,r+1),a=!0;break}a?e=!1:e=!0;const f=t||e;e&&!t&&this.rxEventQueue.push({type:"RX_ERROR",payload:"DATA_MISMATCH"}),this.rxEventQueue.push({type:"RX_DATA",payload:{char:String.fromCharCode(s),error:f}}),this.dataEmitted=!0}tick(s,t){if(this.state==="HUNTING")return this.lastRxLevel===1&&t===0&&(this.state="SAMPLING",this.bitDuration=1/x,this.timeSinceStart=0,this.rxBuffer=0,this.dataEmitted=!1,this.signalAccumulator=0,this.sampleCount=0),this.lastRxLevel=t,0;if(this.state==="SAMPLING"){const e=Math.max(0,this.timeSinceStart);this.timeSinceStart+=s,this.lastRxLevel=t;const a=this.timeSinceStart%this.bitDuration/this.bitDuration;e%this.bitDuration/this.bitDuration<.2&&a>=.2&&(this.signalAccumulator=0,this.sampleCount=0),a>.2&&a<.8&&(this.signalAccumulator+=t,this.sampleCount++);const n=1+i.dataBits+(i.parity!=="none"?1:0)+i.stopBits;if(this.timeSinceStart>(n+.5)*this.bitDuration)return t===0&&this.rxEventQueue.push({type:"RX_ERROR",payload:"BREAK"}),this.state="HUNTING",0;const f=e/this.bitDuration,r=this.timeSinceStart/this.bitDuration,c=Math.floor(f-.5),g=Math.floor(r-.5);if(g>c){const h=g;let d=t;if(this.sampleCount>0&&(d=this.signalAccumulator/this.sampleCount>=.5?1:0),h===0)return 1;if(h<=i.dataBits){const o=h-1;return d===1&&(this.rxBuffer|=1<<o),3}if(i.parity!=="none"){if(h===i.dataBits+1){let o=0;for(let C=0;C<i.dataBits;C++)this.rxBuffer>>C&1&&o++;const N=i.parity==="even"?o%2===0?0:1:o%2!==0?0:1;return d!==N?(this.emitData(this.rxBuffer,!0),this.rxEventQueue.push({type:"RX_ERROR",payload:"PARITY_ERROR"}),2):5}if(h>i.dataBits+1){if(d!==1)return this.emitData(this.rxBuffer,!0),this.rxEventQueue.push({type:"RX_ERROR",payload:"FRAMING_ERROR"}),this.state="HUNTING",2;const o=i.dataBits+1+i.stopBits;return h===o&&(this.emitData(this.rxBuffer,!1),this.state="HUNTING"),4}}else if(h>i.dataBits){if(d!==1)return this.emitData(this.rxBuffer,!0),this.rxEventQueue.push({type:"RX_ERROR",payload:"FRAMING_ERROR"}),this.state="HUNTING",2;const o=i.dataBits+i.stopBits;return h===o&&(this.emitData(this.rxBuffer,!1),this.state="HUNTING"),4}}return 0}return 0}}const I=new P,D=new M;m.onmessage=R=>{const{type:s,payload:t}=R.data;switch(s){case"START":p||(p=!0,O());break;case"STOP":p=!1,l&&(clearInterval(l),l=null);break;case"CONFIGURE":t.txBaud&&(T=t.txBaud,I.updateConfig()),t.rxBaud&&(x=t.rxBaud),t.txConfig&&(u={...u,...t.txConfig}),t.rxConfig&&(i={...i,...t.rxConfig});break;case"TRANSMIT":if(t.char){const e=typeof t.char=="string"?t.char.charCodeAt(0):t.char;S.push(e)}break;case"SET_AUTO":t.enabled!==void 0&&(E=t.enabled);break;case"SET_SPEED":t.speed!==void 0&&(y=t.speed);break}};function O(){l=self.setInterval(()=>{if(!p)return;const s=Math.max(T,x);A=Math.max(60,s*10);const e=1/A,a=[[],[],[],[],[],[],[]],b=Math.ceil(A/60*y);for(let n=0;n<b;n++){v+=e;const f=I.tick(e),r=D.tick(e,f);a[0].push(v),a[1].push(f);const c=-.2;if(a[2].push(r===1?c:null),a[3].push(r===2?c:null),a[4].push(r===3?c:null),a[5].push(r===4?c:null),a[6].push(r===5?c:null),I.shouldSignalComplete()){m.postMessage({type:"TX_COMPLETE"}),I.txCompleteSent=!0,p=!1,l&&(clearInterval(l),l=null);break}}for(m.postMessage({type:"DATA",payload:a});D.rxEventQueue.length>0;){const n=D.rxEventQueue.shift();n&&m.postMessage(n)}},16.666666666666668)}})();
